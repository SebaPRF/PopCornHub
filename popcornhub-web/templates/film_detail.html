{% extends "base.html" %}

{% block title %}{{ film.titre }} - PopCornHub{% endblock %}

{% block content %}
<div class="container my-4">

  <div class="row g-4">
    <div class="col-md-4">
      {% if film.affiche_url %}
        <img src="{{ film.affiche_url }}"
             alt="Affiche de {{ film.titre }}"
             class="img-fluid rounded shadow">
      {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center"
             style="height: 420px;">
          <span class="text-light">Affiche indisponible</span>
        </div>
      {% endif %}
    </div>

    <div class="col-md-8">

      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
        <div>
          <h1 class="mb-2">{{ film.titre }}</h1>

          <p class="text-light mb-2">
            {% if film.annee %}{{ film.annee }}{% endif %}
            {% if film.realisateur %} • Réalisateur : {{ film.realisateur }}{% endif %}
          </p>
        </div>

        {% if trailer_key %}
        <div class="mt-1">
          <button class="btn btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#trailerModal">
            Voir la bande-annonce
          </button>
        </div>
        {% endif %}
      </div>

      {% if film.genres %}
        <p class="mb-3">
          {% for g in film.genres %}
            <span class="badge rounded-pill bg-warning text-dark me-1 mb-1">{{ g }}</span>
          {% endfor %}
        </p>
      {% endif %}

      {% if film.resume %}
        <p class="mb-3 text-light">{{ film.resume }}</p>
      {% endif %}

      <div class="mb-3">
        {% if avg_rating %}
          <span class="fw-semibold text-light">Note moyenne :</span>
          <span class="text-warning">{{ avg_rating }}/5</span>
          <span class="text-light">({{ reviews_count }} avis)</span>
        {% else %}
          <span class="text-light">Aucun avis pour le moment.</span>
        {% endif %}
      </div>

      <h2 class="h4 mb-3 text-light">Distribution</h2>

      <div class="d-flex flex-wrap gap-2 mb-4">
        {% for actor in actors %}
          <a href="{{ url_for('films_bp.actor_films', actor_name=actor.name) }}"
             class="btn btn-outline-light btn-sm d-flex align-items-center rounded-pill"
             style="background-color:#111;">
            <span class="rounded-circle overflow-hidden me-2"
                  style="width:32px;height:32px;">
              <img src="{{ actor.image_url }}"
                   alt="{{ actor.name }}"
                   class="w-100 h-100"
                   style="object-fit:cover;">
            </span>
            <span class="small">{{ actor.name }}</span>
          </a>
        {% endfor %}
      </div>

      <hr class="my-4">

      <h3 class="text-white mb-3">Gestion du film</h3>

      <div class="d-flex flex-wrap gap-3 mb-3">
        {% if session.get('user_id') %}
          <button class="btn btn-warning"
                  data-bs-toggle="modal"
                  data-bs-target="#ownFilmModal">
            Ajouter à ma vidéothèque
          </button>

          <a href="{{ url_for('films_bp.film_availability', film_id=film.id) }}"
            class="btn btn-outline-light">
            Voir les exemplaires disponibles
          </a>
        {% else %}
          <button class="btn btn-warning"
                  data-bs-toggle="modal"
                  data-bs-target="#loginRequiredModal">
            Ajouter à ma vidéothèque
          </button>

          <button class="btn btn-outline-light"
                  data-bs-toggle="modal"
                  data-bs-target="#loginRequiredModal">
            Voir les exemplaires disponibles
          </button>
        {% endif %}
      </div>

      <hr class="my-3">

      <h2 class="h4 mb-3 text-light">Avis des utilisateurs</h2>

      {% if session.get('user_id') %}
        <form action="{{ url_for('films_bp.add_or_update_review', film_id=film.id) }}"
              method="post"
              class="mb-4">
          <div class="row g-2 align-items-center">
            <div class="col-md-2">
              <label for="rating" class="form-label mb-0 text-light">Votre note</label>
              <select name="rating" id="rating" class="form-select form-select-sm">
                {% for n in range(1, 6) %}
                  <option value="{{ n }}"
                          {% if n == 5 %}selected{% endif %}>
                    {{ n }}/5
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-8">
              <label for="comment" class="form-label mb-0 text-light">Commentaire</label>
              <textarea name="comment" id="comment" rows="2"
                        class="form-control form-control-sm"
                        placeholder="Partagez votre avis..."></textarea>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-popcorn-primary w-100">
                Enregistrer
              </button>
            </div>
          </div>
        </form>
      {% else %}
        <p class="text-light">
          <a href="{{ url_for('auth_bp.login') }}" class="link-light">Connectez-vous</a>
          pour laisser un avis.
        </p>
      {% endif %}

      {% if reviews %}
      <div class="list-group list-group-flush">
        {% for r in reviews %}
          <div class="list-group-item bg-dark border-secondary">
            <div class="d-flex justify-content-between">
              
              <div class="d-flex align-items-center mb-2">

                <div class="d-flex align-items-center gap-2">
                  <div class="rounded-circle bg-warning text-dark d-flex align-items-center justify-content-center"
                       style="width:32px;height:32px;font-weight:600;">
                    {{ r.username[:1]|upper }}
                  </div>
            
                  <span class="text-light fw-semibold" style="font-size:0.95rem;">
                    {{ r.username }}
                  </span>
                </div>
            
                <span class="ms-3 text-warning fw-bold">{{ r.rating }}/5</span>
            </div>

              <small class="text-light">
                {{ r.created_at }}
              </small>
            </div>

            {% if r.comment %}
              <p class="mb-0 mt-1 text-light">{{ r.comment }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    </div>
  </div>
</div>

{% if trailer_key %}
<div class="modal fade" id="trailerModal" tabindex="-1"
     aria-labelledby="trailerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-light" id="trailerModalLabel">
          Bande-annonce – {{ film.titre }}
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-0">
        <div class="ratio ratio-16x9">
          <iframe id="trailerIframe"
                  src=""
                  data-src="https://www.youtube.com/embed/{{ trailer_key }}?rel=0&autoplay=1"
                  title="Bande-annonce {{ film.titre }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen>
          </iframe>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="ownFilmModal" tabindex="-1"
     aria-labelledby="ownFilmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post"
          action="{{ url_for('films_bp.own_film', film_id=film.id) }}"
          class="modal-content bg-dark text-light rounded-4 shadow-lg border-0">
      <div class="modal-header border-0" style="background:#111;">
        <h5 class="modal-title" id="ownFilmModalLabel">
          Ajouter “{{ film.titre }}” à votre vidéothèque
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Fermer"></button>
      </div>
      <div class="modal-body">

        <p class="small text-light mb-3" style="opacity: .8;">
          Sélectionnez les formats que vous possédez et, si vous le souhaitez,
          indiquez un prix pour une location à d’autres utilisateurs.
        </p>

        <div class="form-check mb-2">
          <input class="form-check-input"
                 type="checkbox"
                 value="1"
                 id="ownBluray"
                 name="has_bluray"
                 {% if ownership_for_user and ownership_for_user.has_bluray %}checked{% endif %}>
          <label class="form-check-label" for="ownBluray">
            Blu-ray (physique)
          </label>
        </div>
        <div class="row mb-3 ps-3">
          <div class="col-6">
            <label class="form-label form-label-sm">Prix location Blu-ray (€)</label>
            <input type="text"
                   name="bluray_price"
                   class="form-control form-control-sm"
                   placeholder="ex: 2.50"
                   value="{% if ownership_for_user and ownership_for_user.bluray_price is not none %}{{ ownership_for_user.bluray_price }}{% endif %}">
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm">Durée max (jours)</label>
            <input type="number"
                   name="bluray_max_days"
                   min="1"
                   class="form-control form-control-sm"
                   value="{% if ownership_for_user and ownership_for_user.bluray_max_days %}{{ ownership_for_user.bluray_max_days }}{% endif %}">
          </div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input"
                 type="checkbox"
                 value="1"
                 id="ownDigital"
                 name="has_digital"
                 {% if ownership_for_user and ownership_for_user.has_digital %}checked{% endif %}>
          <label class="form-check-label" for="ownDigital">
            Version digitale / streaming
          </label>
        </div>
        <div class="row mb-2 ps-3">
          <div class="col-6">
            <label class="form-label form-label-sm">Prix location Digital (€)</label>
            <input type="text"
                   name="digital_price"
                   class="form-control form-control-sm"
                   placeholder="ex: 1.99"
                   value="{% if ownership_for_user and ownership_for_user.digital_price is not none %}{{ ownership_for_user.digital_price }}{% endif %}">
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm">Durée max (jours)</label>
            <input type="number"
                   name="digital_max_days"
                   min="1"
                   class="form-control form-control-sm"
                   value="{% if ownership_for_user and ownership_for_user.digital_max_days %}{{ ownership_for_user.digital_max_days }}{% endif %}">
          </div>
        </div>

      </div>
      <div class="modal-footer border-0" style="background:#111;">
        <button type="button"
                class="btn btn-outline-light"
                data-bs-dismiss="modal">Annuler</button>
        <button type="submit"
                class="btn btn-warning fw-semibold">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="loginRequiredModal" tabindex="-1"
     aria-labelledby="loginRequiredLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-4 shadow-lg border-0">
      <div class="modal-header border-0" style="background:#111;">
        <h5 class="modal-title" id="loginRequiredLabel">
          Connexion requise
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          Vous devez être connecté pour ajouter un film à votre vidéothèque
          ou voir les exemplaires disponibles.
          Connectez-vous ou créez un compte pour continuer.
        </p>
      </div>
      <div class="modal-footer border-0" style="background:#111;">
        <a href="{{ url_for('auth.login', next=request.path) }}"
           class="btn btn-warning fw-semibold">
          Se connecter
        </a>
        <a href="{{ url_for('auth.signup') }}"
           class="btn btn-outline-light">
          Créer un compte
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if trailer_key %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var modalEl = document.getElementById('trailerModal');
      if (!modalEl) return;

      var iframe = document.getElementById('trailerIframe');
      if (!iframe) return;

      var videoSrc = iframe.getAttribute('data-src');

      modalEl.addEventListener('shown.bs.modal', function () {
        iframe.setAttribute('src', videoSrc);
      });

      modalEl.addEventListener('hidden.bs.modal', function () {
        iframe.setAttribute('src', '');
      });
    });
  </script>
  {% endif %}
{% endblock %}