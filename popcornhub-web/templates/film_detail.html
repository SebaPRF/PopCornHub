{% extends "base.html" %}

{% block title %}{{ film.titre }} - PopCornHub{% endblock %}

{% block content %}
<div class="container my-4">

  <div class="row g-4">
    <!-- Affiche -->
    <div class="col-md-4">
      {% if film.affiche_url %}
        <img src="{{ film.affiche_url }}" alt="Affiche de {{ film.titre }}" class="img-fluid rounded shadow">
      {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center"
             style="height: 420px;">
          <span class="text-light">Affiche indisponible</span>
        </div>
      {% endif %}
    </div>

    <!-- Infos film -->
    <div class="col-md-8">
      <h1 class="mb-2">{{ film.titre }}</h1>
      <p class="text-muted mb-2">
        {% if film.annee %}{{ film.annee }}{% endif %}
        {% if film.realisateur %} • Réalisateur : {{ film.realisateur }}{% endif %}
      </p>

      {% if film.genres %}
        <p class="mb-3">
          {% for g in film.genres %}
            <span class="badge rounded-pill bg-warning text-dark me-1 mb-1">{{ g }}</span>
          {% endfor %}
        </p>
      {% endif %}

      {% if film.resume %}
        <p class="mb-4">{{ film.resume }}</p>
      {% endif %}

      <!-- Boutons principaux -->
      <div class="d-flex flex-wrap gap-2 mb-4">
        <!-- Ajouter à ma vidéothèque -->
        <button class="btn btn-warning fw-semibold"
                data-bs-toggle="modal"
                data-bs-target="#ownFilmModal">
          Ajouter à ma vidéothèque
        </button>

        <!-- Voir les exemplaires disponibles -->
        <a href="{{ url_for('film_availability', film_id=film.id) }}"
           class="btn btn-outline-light">
          Voir les exemplaires disponibles
          {% if owners_count and owners_count > 0 %}
            <span class="badge bg-success ms-1">{{ owners_count }}</span>
          {% endif %}
        </a>

        {% if trailer_key %}
          <!-- Bande-annonce en popup (modal) -->
          <button type="button"
                  class="btn btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#trailerModal">
            Voir la bande-annonce
          </button>
        {% endif %}
      </div>

      <!-- Bloc note moyenne -->
      <div class="mb-3">
        {% if avg_rating %}
          <span class="fw-semibold">Note moyenne :</span>
          <span class="text-warning">{{ avg_rating }}/5</span>
          <span class="text-muted">({{ reviews_count }} avis)</span>
        {% else %}
          <span class="text-muted">Aucun avis pour le moment.</span>
        {% endif %}
      </div>

    </div>
  </div>

  <hr class="my-4">

  <!-- Distribution (acteurs) -->
  <h2 class="h4 mb-3">Distribution</h2>
  <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3 mb-4">
    {% for actor in actors %}
      <div class="col">
        <div class="card bg-dark border-0 h-100">
          <div class="ratio ratio-2x3">
            <img src="{{ actor.image_url }}"
                 class="card-img-top"
                 alt="{{ actor.name }}">
          </div>
          <div class="card-body p-2">
            <p class="card-title mb-0 small text-center">
              <a href="{{ url_for('actor_films', actor_name=actor.name) }}"
                 class="link-light text-decoration-none">
                {{ actor.name }}
              </a>
            </p>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <hr class="my-4">

  <!-- Avis utilisateurs -->
  <h2 class="h4 mb-3">Avis des utilisateurs</h2>

  {% if session.get('user_id') %}
    <form action="{{ url_for('add_or_update_review', film_id=film.id) }}" method="post" class="mb-4">
      <div class="row g-2 align-items-center">
        <div class="col-md-2">
          <label for="rating" class="form-label mb-0">Votre note</label>
          <select name="rating" id="rating" class="form-select form-select-sm">
            {% for n in range(1,6) %}
              <option value="{{ n }}"
                      {% if user_review and user_review.rating == n %}selected{% endif %}>
                {{ n }}/5
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-8">
          <label for="comment" class="form-label mb-0">Commentaire</label>
          <textarea name="comment" id="comment" rows="2"
                    class="form-control form-control-sm"
                    placeholder="Partagez votre avis...">{% if user_review %}{{ user_review.comment }}{% endif %}</textarea>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-popcorn-primary w-100">
            Enregistrer
          </button>
        </div>
      </div>
    </form>
  {% else %}
    <p class="text-muted">
      <a href="{{ url_for('login') }}" class="link-light">Connectez-vous</a> pour laisser un avis.
    </p>
  {% endif %}

  {% if reviews %}
    <div class="list-group list-group-flush">
      {% for r in reviews %}
        <div class="list-group-item bg-dark border-secondary">
          <div class="d-flex justify-content-between">
            <div>
              <strong>{{ r.username }}</strong>
              <span class="ms-2 text-warning">{{ r.rating }}/5</span>
            </div>
            <small class="text-muted">
              {{ r.created_at }}
            </small>
          </div>
          {% if r.comment %}
            <p class="mb-0 mt-1">{{ r.comment }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>

{% if trailer_key %}
<!-- MODAL : Bande-annonce -->
<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="trailerModalLabel">
          Bande-annonce – {{ film.titre }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-0">
        <div class="ratio ratio-16x9">
          <!-- src vide au départ, rempli au moment de l'ouverture -->
          <iframe id="trailerIframe"
                  src=""
                  data-src="https://www.youtube.com/embed/{{ trailer_key }}?rel=0&autoplay=1"
                  title="Bande-annonce {{ film.titre }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen>
          </iframe>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL : Ajouter à ma vidéothèque -->
<div class="modal fade" id="ownFilmModal" tabindex="-1" aria-labelledby="ownFilmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{{ url_for('own_film', film_id=film.id) }}" class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="ownFilmModalLabel">
          Ajouter “{{ film.titre }}” à votre vidéothèque
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">

        <p class="small text-muted mb-3">
          Sélectionnez les formats que vous possédez et, si vous le souhaitez,
          indiquez un prix pour une location à d’autres utilisateurs.
        </p>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="1" id="ownBluray" name="has_bluray"
                 {% if ownership_for_user and ownership_for_user.has_bluray %}checked{% endif %}>
          <label class="form-check-label" for="ownBluray">
            Blu-ray (physique)
          </label>
        </div>
        <div class="row mb-3 ps-3">
          <div class="col-6">
            <label class="form-label form-label-sm">Prix location Blu-ray (€)</label>
            <input type="text"
                   name="bluray_price"
                   class="form-control form-control-sm"
                   placeholder="ex: 2.50"
                   value="{% if ownership_for_user and ownership_for_user.bluray_price is not none %}{{ ownership_for_user.bluray_price }}{% endif %}">
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm">Durée max (jours)</label>
            <input type="number"
                   name="bluray_max_days"
                   min="1"
                   class="form-control form-control-sm"
                   value="{% if ownership_for_user and ownership_for_user.bluray_max_days %}{{ ownership_for_user.bluray_max_days }}{% endif %}">
          </div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="1" id="ownDigital" name="has_digital"
                 {% if ownership_for_user and ownership_for_user.has_digital %}checked{% endif %}>
          <label class="form-check-label" for="ownDigital">
            Version digitale / streaming
          </label>
        </div>
        <div class="row mb-2 ps-3">
          <div class="col-6">
            <label class="form-label form-label-sm">Prix location Digital (€)</label>
            <input type="text"
                   name="digital_price"
                   class="form-control form-control-sm"
                   placeholder="ex: 1.99"
                   value="{% if ownership_for_user and ownership_for_user.digital_price is not none %}{{ ownership_for_user.digital_price }}{% endif %}">
          </div>
          <div class="col-6">
            <label class="form-label form-label-sm">Durée max (jours)</label>
            <input type="number"
                   name="digital_max_days"
                   min="1"
                   class="form-control form-control-sm"
                   value="{% if ownership_for_user and ownership_for_user.digital_max_days %}{{ ownership_for_user.digital_max_days }}{% endif %}">
          </div>
        </div>

      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-warning fw-semibold">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if trailer_key %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var modalEl = document.getElementById('trailerModal');
      if (!modalEl) return;

      var iframe = document.getElementById('trailerIframe');
      if (!iframe) return;

      var videoSrc = iframe.getAttribute('data-src');

      // Quand on ouvre la modal : on charge la vidéo avec autoplay
      modalEl.addEventListener('shown.bs.modal', function () {
        iframe.setAttribute('src', videoSrc);
      });

      // Quand on ferme : on vide la source pour arrêter le son
      modalEl.addEventListener('hidden.bs.modal', function () {
        iframe.setAttribute('src', '');
      });
    });
  </script>
  {% endif %}
{% endblock %}