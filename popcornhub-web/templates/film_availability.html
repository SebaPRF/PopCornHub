{% extends "base.html" %}

{% block content %}
<div class="container my-5">

    <!-- HEADER -->
    <h1 class="text-white mb-2">Exemplaires disponibles — {{ film.titre }}</h1>
    <p class="text-light mb-4">
        Voici les utilisateurs qui possèdent ce film et le proposent éventuellement à la location.
    </p>

    <!-- FILTRES -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label text-light">Format</label>
            <select name="format" class="form-select">
                <option value="all"     {{ "selected" if format_filter == "all" else "" }}>Tous</option>
                <option value="bluray"  {{ "selected" if format_filter == "bluray" else "" }}>Blu-ray</option>
                <option value="digital" {{ "selected" if format_filter == "digital" else "" }}>Streaming</option>
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label text-light">Trier par</label>
            <select name="sort_by" class="form-select">
                <option value="price_asc"  {{ "selected" if sort_by == "price_asc" else "" }}>Prix croissant</option>
                <option value="price_desc" {{ "selected" if sort_by == "price_desc" else "" }}>Prix décroissant</option>
            </select>
        </div>

        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-warning w-100 fw-semibold">Filtrer</button>
        </div>
    </form>


    <!-- LISTE DES EXEMPLAIRES -->
    {% for e in entries %}
    <div class="p-4 mb-4 rounded-4" style="background:#1b1d22; border:1px solid #333;">

        <!-- VENDEUR -->
        <div class="d-flex align-items-center mb-2">

            <div class="rounded-circle d-flex align-items-center justify-content-center me-2"
                 style="width:34px;height:34px;background:#f8b400;color:#000;font-weight:700;">
                {{ e.owner_name[0]|upper }}
            </div>

            <h5 class="text-white mb-0">{{ e.owner_name }}</h5>
        </div>

        <!-- FORMATS DISPONIBLES -->
        {% if e.has_bluray %}
            <p class="text-light mb-1">
                <strong>Blu-ray :</strong>
                {{ "%.2f"|format(e.bluray_price) }} € • {{ e.bluray_max_days }} j max
            </p>
        {% endif %}

        {% if e.has_digital %}
            <p class="text-light mb-3">
                <strong>Streaming :</strong>
                {{ "%.2f"|format(e.digital_price) }} € • {{ e.digital_max_days }} j max
            </p>
        {% endif %}

        <!-- BOUTONS LOUER -->
        <div class="d-flex gap-3">

            {% if e.has_bluray %}
            <button class="btn btn-warning fw-semibold"
                    data-bs-toggle="modal"
                    data-bs-target="#rentBluray-{{ e.owner_id }}">
                Louer le Blu-ray
            </button>
            {% endif %}

            {% if e.has_digital %}
            <button class="btn btn-warning fw-semibold"
                    data-bs-toggle="modal"
                    data-bs-target="#rentDigital-{{ e.owner_id }}">
                Louer en streaming
            </button>
            {% endif %}
        </div>

    </div>

    <!-- MODAL BLU-RAY -->
    {% if e.has_bluray %}
    <div class="modal fade" id="rentBluray-{{ e.owner_id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <form method="post"
                  action="{{ url_for('rent_from_owner', film_id=film.id, owner_id=e.owner_id) }}"
                  class="modal-content bg-dark text-light rounded-4 shadow-lg border-0">

                <div class="modal-header border-0" style="background:#111;">
                    <h5 class="modal-title">
                        Louer « {{ film.titre }} » en Blu-ray chez {{ e.owner_name }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p class="mb-1">Prix : {{ "%.2f"|format(e.bluray_price) }} € — durée max : {{ e.bluray_max_days }} jours</p>

                    <label class="form-label mt-3">Durée de location (jours)</label>
                    <input type="number" name="duration_days"
                           class="form-control"
                           placeholder="ex : 3" min="1">

                    <input type="hidden" name="format" value="bluray">
                </div>

                <div class="modal-footer border-0" style="background:#111;">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning fw-semibold">Confirmer la location</button>
                </div>

            </form>
        </div>
    </div>
    {% endif %}

    <!-- MODAL STREAMING -->
    {% if e.has_digital %}
    <div class="modal fade" id="rentDigital-{{ e.owner_id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <form method="post"
                  action="{{ url_for('rent_from_owner', film_id=film.id, owner_id=e.owner_id) }}"
                  class="modal-content bg-dark text-light rounded-4 shadow-lg border-0">

                <div class="modal-header border-0" style="background:#111;">
                    <h5 class="modal-title">
                        Louer « {{ film.titre }} » en streaming chez {{ e.owner_name }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p class="mb-1">Prix : {{ "%.2f"|format(e.digital_price) }} € — durée max : {{ e.digital_max_days }} jours</p>

                    <label class="form-label mt-3">Durée de location (jours)</label>
                    <input type="number" name="duration_days"
                           class="form-control"
                           placeholder="ex : 3" min="1">

                    <input type="hidden" name="format" value="digital">
                </div>

                <div class="modal-footer border-0" style="background:#111;">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning fw-semibold">Confirmer la location</button>
                </div>

            </form>
        </div>
    </div>
    {% endif %}

    {% endfor %}

</div>
{% endblock %}