{% extends "base.html" %}
{% block title %}Mon profil PopCornHub{% endblock %}

{% block content %}
<div class="container py-5 profile-layout">
  <div class="row g-4">

    <!-- =============== SIDEBAR =============== -->
    <div class="col-md-3 col-lg-2">
      <div class="profile-sidebar">
        <div class="profile-nav-title">Mon profil</div>
        <ul class="nav flex-column profile-nav">

          <!-- Favoris -->
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'favorites' %}active{% endif %}"
               href="{{ url_for('profile', tab='favorites') }}">
              <span class="icon">‚ù§Ô∏è</span> Mes favoris
            </a>
          </li>

          <!-- Ma liste -->
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'library' %}active{% endif %}"
               href="{{ url_for('profile', tab='library') }}">
              <span class="icon">üìå</span> Ma vid√©oth√®que
            </a>
          </li>

          <!-- Locations -->
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'rentals' %}active{% endif %}"
               href="{{ url_for('profile', tab='rentals') }}">
              <span class="icon">üé¨</span> Mes locations
            </a>
          </li>

        </ul>
      </div>
    </div>

    <!-- =============== CONTENU PRINCIPAL =============== -->
    <div class="col-md-9 col-lg-10">

      <h1 class="page-title mb-4">Mon profil PopCornHub</h1>

      <!-- ================= FAVORIS ================= -->
      {% if active_tab == 'favorites' %}
        <h2 class="mb-3">Mes favoris</h2>

        {% if favorite_films %}
          <div class="row row-cols-1 row-cols-md-3 g-4">

            {% for film in favorite_films %}
            <div class="col">
              <div class="film-card h-100" onclick="window.location='{{ url_for('film_detail', film_id=film.id) }}'">
                
                <div class="film-card-poster-wrapper">
                  <img src="{{ film.affiche_url or url_for('static', filename='default_poster.png') }}"
                       alt="{{ film.titre }}"
                       class="film-card-poster"
                       onerror="this.onerror=null; this.src='{{ url_for('static', filename='default_poster.png') }}';">
                </div>

                <div class="film-card-body">
                  <h5 class="film-card-title mb-1">{{ film.titre }}</h5>
                  <p class="film-card-meta">{{ film.annee }}</p>

                  <div class="film-card-actions">

                    <!-- Favoris -->
                    <form method="post"
                          action="{{ url_for('toggle_favorite', film_id=film.id) }}"
                          onclick="event.stopPropagation();">
                      <button class="favorite-btn {% if film.id in favorite_ids %}is-favorite{% endif %}">
                        <span class="favorite-icon">‚ù§</span>
                      </button>
                    </form>

                    <!-- Liste (pin) -->
                    <form method="post"
                          action="{% if film.id in library_ids %}{{ url_for('remove_from_library', film_id=film.id) }}{% else %}{{ url_for('add_to_library', film_id=film.id) }}{% endif %}"
                          onclick="event.stopPropagation();">
                      <button class="pin-btn {% if film.id in library_ids %}is-in-list{% endif %}">
                        <span class="pin-icon">üìå</span>
                      </button>
                    </form>

                  </div>
                </div>
              </div>
            </div>
            {% endfor %}

          </div>
        {% else %}
          <p class="opacity-75 mt-2">Vous n‚Äôavez pas encore ajout√© de favoris.</p>
        {% endif %}
      {% endif %}

      <!-- ================= MA LISTE ================= -->
      {% if active_tab == 'library' %}
        <h2 class="mb-3">Ma vid√©oth√®que</h2>

        {% if library_films %}
          <div class="row row-cols-1 row-cols-md-3 g-4">

            {% for film in library_films %}
            <div class="col">
              <div class="film-card h-100" onclick="window.location='{{ url_for('film_detail', film_id=film.id) }}'">

                <div class="film-card-poster-wrapper">
                  <img src="{{ film.affiche_url or url_for('static', filename='default_poster.png') }}"
                       alt="{{ film.titre }}"
                       class="film-card-poster"
                       onerror="this.onerror=null; this.src='{{ url_for('static', filename='default_poster.png') }}';">
                </div>

                <div class="film-card-body">
                  <h5 class="film-card-title mb-1">{{ film.titre }}</h5>
                  <p class="film-card-meta">{{ film.annee }}</p>

                  <div class="film-card-actions">

                    <!-- Favoris -->
                    <form action="{{ url_for('toggle_favorite', film_id=film.id) }}"
                          method="post"
                          onclick="event.stopPropagation();">
                      <button class="favorite-btn {% if film.id in favorite_ids %}is-favorite{% endif %}">
                        <span class="favorite-icon">‚ù§</span>
                      </button>
                    </form>

                    <!-- Liste (pin) -->
                    <form action="{% if film.id in library_ids %}{{ url_for('remove_from_library', film_id=film.id) }}{% else %}{{ url_for('add_to_library', film_id=film.id) }}{% endif %}"
                          method="post"
                          onclick="event.stopPropagation();">
                      <button class="pin-btn {% if film.id in library_ids %}is-in-list{% endif %}">
                        <span class="pin-icon">üìå</span>
                      </button>
                    </form>

                  </div>
                </div>

              </div>
            </div>
            {% endfor %}

          </div>
        {% else %}
          <p class="opacity-75 mt-2">Aucun film dans votre liste pour l'instant.</p>
        {% endif %}
      {% endif %}

      <!-- ================= LOCATIONS ================= -->
      {% if active_tab == 'rentals' %}
        <h2 class="mb-3">Mes locations</h2>

        {% if rentals %}
          <div class="row row-cols-1 row-cols-md-3 g-4">

            {% for r in rentals %}
            <div class="col">
              <div class="film-card h-100" onclick="window.location='{{ url_for('film_detail', film_id=r.film.id) }}'">

                <div class="film-card-poster-wrapper">
                  <img src="{{ r.film.affiche_url or url_for('static', filename='default_poster.png') }}"
                       alt="{{ r.film.titre }}"
                       class="film-card-poster"
                       onerror="this.onerror=null; this.src='{{ url_for('static', filename='default_poster.png') }}';">
                </div>

                {% if r.is_active %}
                  <span class="rental-badge">Lou√© jusqu'au {{ r.expires_at[:10] }}</span>
                {% endif %}

                <div class="film-card-body">
                  <h5 class="film-card-title">{{ r.film.titre }}</h5>
                  <p class="film-card-meta">{{ r.film.annee }}</p>

                  <div class="d-flex justify-content-between align-items-center">
                    {% if r.is_active %}
                      <a href="{{ url_for('watch_film', film_id=r.film.id) }}"
                         class="btn btn-popcorn-primary btn-sm"
                         onclick="event.stopPropagation();">
                        Regarder
                      </a>
                    {% else %}
                      <span class="text-muted small">Location expir√©e</span>
                    {% endif %}
                    <span class="small">{{ "%.2f"|format(r.price_eur) }} ‚Ç¨</span>
                  </div>
                </div>

              </div>
            </div>
            {% endfor %}

          </div>
        {% else %}
          <p class="opacity-75 mt-2">Vous n'avez pas encore lou√© de films.</p>
        {% endif %}
      {% endif %}

    </div>

  </div>
</div>
{% endblock %}